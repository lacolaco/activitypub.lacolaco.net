name: 'ci'

on:
  pull_request:
    types: ['opened', 'synchronize', 'reopened']

permissions:
  contents: 'read'
  id-token: 'write'

jobs:
  build-server:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: google-github-actions/auth@v1.1.1
        id: 'auth'
        with:
          workload_identity_provider: ${{ vars.GOOGLE_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ vars.GOOGLE_DEPLOY_SERVICE_ACCOUNT }}
      - uses: ./.github/actions/setup-node
      - uses: ./.github/actions/setup-go
      - run: cp .env.example .env
      - run: docker build -f ./Dockerfile .

  test-server:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: google-github-actions/auth@v1.1.1
        id: 'auth'
        with:
          workload_identity_provider: ${{ vars.GOOGLE_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ vars.GOOGLE_DEPLOY_SERVICE_ACCOUNT }}
      - uses: ./.github/actions/setup-go
      - run: cp .env.example .env
      - run: go mod download
      - run: go vet ./...
      # - run: go test ./...

  test-client:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: ./.github/actions/setup-node
      - run: yarn install
        working-directory: client
      - run: yarn build
        working-directory: client
